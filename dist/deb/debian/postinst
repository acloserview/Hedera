#!/bin/sh
set -e
type curl >/dev/null 2>&1 || {
	echo >&2 "I require curl but it's not installed. Aborting.";exit 1;}
type sed >/dev/null 2>&1 || {
	echo >&2 "I require sed but it's not installed. Aborting.";exit 1;}
type find >/dev/null 2>&1 || {
	echo >&2 "I require findutils but it's not installed. Aborting.";exit 1;}
_tmpdir=/tmp
if [ -d "${_tmpdir}"/Hedera-master ]; then
	rm -rf "${_tmpdir}"/Hedera-master
fi
if [ ! -d /usr/share/themes ];then
    printf "/usr isn't your default prefix - aborting!\n"
    exit 1
fi
#FIXME add loop/integrity checks
printf '\n==> Downloading the latest release from GitHub!\n'
curl -L https://github.com/sixsixfive/Hedera/archive/master.zip > "${_tmpdir}"/Hedera-master.zip --progress-bar
printf '\n==> Extracting...\n'
cd "${_tmpdir}"
if ($type 7z >/dev/null 2>&1); then
	7z x "${_tmpdir}"/Hedera-master.zip -o"${_tmpdir}"
elif ($type unzip >/dev/null 2>&1); then
	unzip Hedera-master.zip -d "${_tmpdir}"
else
	printf "\nYou either need 7z or unzip - Aborting!.\n"
	exit 1
fi
if [ -f "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/themes/Hedera/gtk-3.20/gtk.css ]; then
	rm -f "${_tmpdir}"/Hedera-master.zip
else
	printf "\nfailed to extract\n"
	exit 1
fi
ln -s gtk-3.20 "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/themes/Hedera/gtk-3.0
cd "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/
#filelist
mkdir -p "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/Hedera-theme
find . -not -type d|sed 's#^./#/usr/share/#' >>"${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/Hedera-theme/files
#set as systemwide theme
if [ ! -f /etc/gtk-3.0/settings.ini ]; then
    cp "${_tmpdir}"/Hedera-master/CONFIGS/etc/gtk-3.0/settings.ini /etc/gtk-3.0/settings.ini
    printf '/etc/gtk-3.0/settings.ini\n'>>"${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/Hedera-theme/files
fi
#kill the overlay scrollbar
if [ ! -f /etc/profile.d/gtk3-noosb.sh ]; then
    cp "${_tmpdir}"/Hedera-master/CONFIGS/etc/profile.d/gtk3-noosb.sh /etc/profile.d/gtk3-noosb.sh
    printf '/etc/profile.d/gtk3-noosb.sh\n'>>"${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/Hedera-theme/files
fi
chown -R root:root "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS
chmod -R 755 "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS
cp -pR "${_tmpdir}"/Hedera-master/CP_TO_DATADIRS/* /usr/share/
printf '\n==> Done!\n'
